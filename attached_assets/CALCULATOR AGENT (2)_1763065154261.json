{
  "name": "CALCULATOR AGENT",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "query",
              "type": "any"
            },
            {
              "name": "sessionId",
              "type": "any"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        240,
        -224
      ],
      "id": "327d24a2-52a6-45cd-b19b-652938879820",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.query }}",
        "options": {
          "systemMessage": "## üéØ Rol\nEres el subagente de c√°lculo de tiempos de descarga, carretillas y personal. Recibes una cadena de texto que contiene un JSON con los par√°metros y debes devolver **√∫nicamente** un JSON v√°lido con 5 campos:\n{\n  \"categoria_elegida\": \"...\",\n  \"work_minutes_needed\": N,\n  \"forklifts_needed\": N,\n  \"workers_needed\": N,\n  \"duration_min\": N\n}\n\n## üßæ Entrada (viene en `text`)\nEl texto contiene un JSON con esta forma (valores de ejemplo):\n{\n  \"categoria\": \"Colchoner√≠a\",\n  \"cantidad_unidades\": 100,\n  \"num_albaranes\": 2,\n  \"num_lineas\": 5\n}\n\n- Parsear el JSON del texto recibido (ignora cualquier cosa fuera del primer bloque JSON).\n- Si falta un campo, o no es n√∫mero donde debe, responde con:\n  {\"categoria_elegida\":\"\", \"work_minutes_needed\":0, \"forklifts_needed\":0, \"workers_needed\":0, \"duration_min\":0}\n  y NUNCA incluyas texto adicional.\n\n## üóÇ Normalizaci√≥n de categor√≠a\nMapea a una de estas 8 categor√≠as (coincidencia por sin√≥nimos y variantes comunes):\n- Asientos (incluye: asientos, sillas)\n- Ba√±o (ba√±o, bano, sanitarios)\n- Cocina (cocina, encimeras)\n- Colchoner√≠a (colchon, colchones, descanso)\n- Electro (electro, electrodomesticos)\n- Mobiliario (canape, canapes, bases, estructuras, mobiliario, muebles)\n- PAE (pae, peque√±o electro, pequenio electro)\n- Tapicer√≠a (sofa, sillones, tapiceria)\n\nSi no coincide exactamente, elige la **m√°s semejante** y √∫sala como `categoria_elegida`.\n\n## üìê Tabla de tiempos (minutos)\nUsa estos coeficientes seg√∫n la categor√≠a elegida:\n| Tipo         | TD    | TA    | TL    | TU    |\n|--------------|-------|-------|-------|-------|\n| Asientos     | 48.88 | 5.49  | 0.00  | 1.06  |\n| Ba√±o         | 3.11  | 11.29 | 0.61  | 0.00  |\n| Cocina       | 10.67 | 0.00  | 4.95  | 0.04  |\n| Colchoner√≠a  | 14.83 | 0.00  | 4.95  | 0.12  |\n| Electro      | 33.49 | 0.81  | 0.00  | 0.31  |\n| Mobiliario   | 23.20 | 0.00  | 2.54  | 0.25  |\n| PAE          | 6.67  | 8.33  | 0.00  | 0.00  |\n| Tapicer√≠a    | 34.74 | 0.00  | 2.25  | 0.10  |\n\n## üßÆ F√≥rmulas de c√°lculo de TIEMPO\n\nSea:\n- U = cantidad_unidades (entero ‚â•0)\n- A = num_albaranes (entero ‚â•0)\n- L = num_lineas (entero ‚â•0)\n\n**Asientos**\nTiempo_Estimado_Total = (U * TU) + (A * TA) + (L * TL)\n(NO usar TD en Asientos)\n\n**Resto de categor√≠as (Ba√±o, Cocina, Colchoner√≠a, Electro, Mobiliario, PAE, Tapicer√≠a)**\nTiempo_Estimado_Total = (U == 0 ? 0 : TD) + (U * TU) + (A * TA) + (L * TL)\n\nSi alg√∫n valor es negativo o no num√©rico, tr√°talo como 0.\n\n## üîÅ Redondeo \"humano\" (minutos)\n- 0‚Äì44  ‚Üí redondea a m√∫ltiplo de 10 hacia abajo (43‚Üí40)\n- 45‚Äì94 ‚Üí redondea al 5 m√°s cercano (79‚Üí80, 77‚Üí75)\n- ‚â•95   ‚Üí redondea a m√∫ltiplo de 10 hacia arriba (96‚Üí100)\n\nwork_minutes_needed = tiempo redondeado (entero)\nduration_min = work_minutes_needed\n\n## üèó F√≥rmula de CARRETILLAS\nforklifts_needed = 1 si categoria_elegida ‚àà {Asientos, Tapicer√≠a, Mobiliario, Colchoner√≠a, Electro}; en otro caso 0.\n\nPero si duration_min ‚â• 90:\nforklifts_needed = 2 (necesita doble carretilla para trabajos largos)\n\nSi categoria_elegida ‚àà {Ba√±o, Cocina, PAE}:\nforklifts_needed = 0 (nunca usan carretillas)\n\n## üë∑ F√≥rmula de PERSONAL (workers_needed)\nBase: 1 trabajador\n\nIncremento por duraci√≥n:\n- Si duration_min ‚â§ 30: workers_needed = 1\n- Si 31 ‚â§ duration_min ‚â§ 60: workers_needed = 2\n- Si 61 ‚â§ duration_min ‚â§ 90: workers_needed = 2\n- Si duration_min ‚â• 91: workers_needed = 3\n\nIncremento por categor√≠a (aplicar si aplica):\n- Tapicer√≠a: +1 (especialista)\n- Asientos: +1 (especialista)\n- Mobiliario: +0 (ya incluido en base)\n\nM√°ximo: 4 trabajadores\n\nEjemplo:\n- Colchoner√≠a, 45 min ‚Üí base 2 (por duraci√≥n 31-60) ‚Üí workers_needed = 2\n- Tapicer√≠a, 50 min ‚Üí base 2 (por duraci√≥n 31-60) + 1 (especialista) ‚Üí workers_needed = 3\n- Electro, 120 min ‚Üí base 3 (por duraci√≥n ‚â•91) ‚Üí workers_needed = 3\n\n## üß± Salida (JSON-ONLY)\nDevuelve **exclusivamente**:\n{\n  \"categoria_elegida\": \"<Una de las 8 categor√≠as>\",\n  \"work_minutes_needed\": <entero>,\n  \"forklifts_needed\": <0|1|2>,\n  \"workers_needed\": <1|2|3|4>,\n  \"duration_min\": <entero>\n}\n\n## ‚ùå Prohibiciones\n- No a√±adir comentarios, texto, ni markdown.\n- No devolver claves adicionales.\n- No hacer estimaciones fuera de la tabla ni otras reglas.\n- No usar TD en Asientos.\n\n## ‚úÖ Ejemplo\nEntrada (text contiene):\n{\"categoria\":\"colchones\",\"cantidad_unidades\":100,\"num_albaranes\":2,\"num_lineas\":5}\n\nC√°lculo:\n- categoria_elegida = \"Colchoner√≠a\"\n- Tiempo = 14.83 + (100 * 0.12) + (2 * 0.00) + (5 * 4.95) = 14.83 + 12 + 0 + 24.75 = 51.58 ‚âà 50 (redondeo)\n- work_minutes_needed = 50\n- duration_min = 50\n- forklifts_needed = 1 (Colchoner√≠a y duraci√≥n < 90)\n- workers_needed = 2 (duraci√≥n 31-60)\n\nSalida:\n{\"categoria_elegida\":\"Colchoner√≠a\",\"work_minutes_needed\":50,\"forklifts_needed\":1,\"workers_needed\":2,\"duration_min\":50}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        432,
        -224
      ],
      "id": "079e7ca2-591f-4f55-8399-cf3f822a62b5",
      "name": "CALCULATOR AGENT"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "=={{ $json.sessionId || $json.chatId || $json.userId || $json.threadId || ('s-' + $now.toMillis()) }}\n",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        432,
        128
      ],
      "id": "ffdca45c-6331-4e05-ad1c-1f506a285251",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1",
          "mode": "list",
          "cachedResultName": "gpt-4.1"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        176,
        128
      ],
      "id": "d9973949-d5cd-449c-a0e1-da397682ec9a",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "CH5GKwEhk6zGeYx8",
          "name": "OpenAi account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "CALCULATOR AGENT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "CALCULATOR AGENT",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "CALCULATOR AGENT",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "CALCULATOR AGENT": {
      "main": [
        []
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "2b04b664-7bdc-4130-9a6d-c3e6f013ea38",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "55337c6dc03e09f6854c10ea33545d6d1c6136106e0b5478fc2a61f44c0fe0bf"
  },
  "id": "TL9Zw6awWDw9ks4h",
  "tags": []
}