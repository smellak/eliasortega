# Plan de Implementaci√≥n de Mejoras
## Sistema de Gesti√≥n de Citas de Almac√©n ‚Äî Centro Hogar Sanchez

**Versi√≥n:** 2.0  
**Fecha:** Febrero 2026  
**Estado:** Propuesta de mejoras sobre v1.0

---

> **Prop√≥sito del documento:** Este documento detalla el plan completo de mejoras para el Sistema de Gesti√≥n de Citas de Almac√©n de Centro Hogar Sanchez. Incluye la simplificaci√≥n del modelo de capacidad (Opci√≥n B: Slots con Tallas), optimizaci√≥n del agente IA, y mejoras de infraestructura, seguridad y operativa. Cada mejora incluye justificaci√≥n, especificaci√≥n t√©cnica, prioridad y estimaci√≥n.

---

## 1. Resumen Ejecutivo

El sistema actual (v1.0) funciona correctamente pero presenta oportunidades de mejora significativas en tres √°reas clave:

| √Årea | Problema | Soluci√≥n propuesta | Impacto |
|------|----------|-------------------|---------|
| **Capacidad** | Modelo minuto a minuto demasiado complejo para el equipo de almac√©n | Slots fijos con sistema de tallas (S/M/L) | Alto |
| **Agente IA** | Modelo sobredimensionado y costoso para un flujo lineal | Modelo m√°s ligero + flujo h√≠brido determinista/IA | Alto |
| **Operativa** | Sin notificaciones, auditor√≠a ni trazabilidad | Notificaciones por email + log de auditor√≠a | Alto |
| **Seguridad** | API de integraci√≥n abierta por defecto, sesiones d√©biles | API cerrada por defecto + sesi√≥n mejorada para chat | Medio |
| **Arquitectura** | Servidor √∫nico puede bloquearse con llamadas a LLM | Separar worker IA del servidor HTTP | Medio |
| **Datos** | Desnormalizaci√≥n innecesaria de provider_name | Usar siempre relaci√≥n FK, crear proveedor al vuelo | Bajo |

> **Estimaci√≥n global:** Tiempo total estimado: 6-8 semanas de desarrollo. Se recomienda implementar en 4 fases incrementales, empezando por los cambios de mayor impacto (capacidad y notificaciones) y terminando con optimizaciones de arquitectura.

---

## 2. Simplificaci√≥n del Modelo de Capacidad

### 2.1 Problema actual

El sistema actual valida capacidad minuto a minuto, calculando tasas de trabajo fraccionarias y comparando con recursos disponibles en cada instante. Aunque es matem√°ticamente preciso, presenta varios problemas pr√°cticos:

- El jefe de almac√©n no puede explicar a un proveedor por qu√© no cabe su cita: ¬´en el minuto 47 la tasa de trabajo supera 2.7 trabajadores¬ª no es un mensaje comprensible.
- Los indicadores de capacidad muestran porcentajes abstractos que no se traducen en decisiones operativas claras.
- Los conflictos de capacidad son dif√≠ciles de resolver manualmente porque el modelo es opaco.

### 2.2 Soluci√≥n: Sistema de Slots con Tallas

#### 2.2.1 Concepto general

La jornada se divide en franjas horarias fijas (slots). Cada slot tiene un n√∫mero m√°ximo de puntos de capacidad. Las descargas se clasifican en tallas (S, M, L) que consumen diferente cantidad de puntos. Una descarga solo se puede programar si hay suficientes puntos libres en el slot.

> **Ejemplo mental:** Franja 08:00-10:00 tiene 6 puntos. Un cami√≥n de colchones (talla M) gasta 2 puntos. Un cami√≥n grande de sof√°s (talla L) gasta 3 puntos. En esta franja caben: 3 medianos, o 2 grandes, o 1 grande + 1 mediano + 1 peque√±o. El jefe de almac√©n entiende esto instant√°neamente.

#### 2.2.2 Configuraci√≥n de slots

| Par√°metro | Valor por defecto | Configurable |
|-----------|-------------------|:------------:|
| Franjas horarias (L-V) | 08:00-10:00, 10:00-12:00, 12:00-14:00 | S√≠, desde panel |
| Franjas horarias (S√°bado) | 08:00-11:00, 11:00-14:00 | S√≠, desde panel |
| Domingo | Cerrado | S√≠ |
| Puntos por franja (L-V) | 6 puntos | S√≠, por franja |
| Puntos por franja (S√°bado) | 4 puntos | S√≠, por franja |

#### 2.2.3 Sistema de tallas

La talla se determina autom√°ticamente a partir de la duraci√≥n estimada por la calculadora de recursos (que no cambia):

| Talla | Duraci√≥n estimada | Puntos que consume | Ejemplos t√≠picos |
|-------|-------------------|:------------------:|------------------|
| **S (Peque√±a)** | ‚â§30 minutos | 1 punto | Electrodom√©sticos peque√±os, ba√±o, PAE |
| **M (Mediana)** | 31-90 minutos | 2 puntos | Colchones, mobiliario est√°ndar, cocina |
| **L (Grande)** | >90 minutos | 3 puntos | Sof√°s grandes, tapicer√≠a voluminosa, mixto |

#### 2.2.4 Modelo de datos modificado

Se reemplaza la tabla `capacity_shifts` por una nueva estructura de slots:

**Nueva tabla: `slot_templates`**

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | String (CUID) | Identificador √∫nico |
| day_of_week | Int (0-6) | D√≠a de la semana (0=lunes, 6=domingo) |
| start_time | String (HH:mm) | Hora de inicio del slot (hora local Madrid) |
| end_time | String (HH:mm) | Hora de fin del slot |
| max_points | Int | Puntos m√°ximos de capacidad |
| active | Boolean | Si el slot est√° activo |

**Nueva tabla: `slot_overrides` (para excepciones)**

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | String (CUID) | Identificador √∫nico |
| date | Date | Fecha espec√≠fica del override |
| start_time | String (HH:mm) | Hora inicio (si null, d√≠a completo cerrado) |
| end_time | String (HH:mm) | Hora fin |
| max_points | Int | Puntos m√°ximos (0 = cerrado) |
| reason | String? | Motivo del override (festivo, evento, etc.) |

**Campos a√±adidos en tabla `appointments`**

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| size | Enum (S, M, L) | Talla de la descarga |
| points_used | Int | Puntos consumidos en el slot |
| slot_date | Date | Fecha del slot asignado |
| slot_start_time | String (HH:mm) | Hora inicio del slot |

**Campos eliminados de `appointments`:**

- `work_minutes_needed` ‚Üí se mantiene internamente para la calculadora pero ya no se usa en validaci√≥n de capacidad
- `forklifts_needed` ‚Üí sustituido por el sistema de puntos

#### 2.2.5 Nuevo algoritmo de validaci√≥n

El nuevo algoritmo es trivial comparado con el actual:

1. Recibir solicitud de cita con fecha y franja horaria deseada
2. Buscar el `slot_template` correspondiente al d√≠a de la semana + franja
3. Verificar si hay un `slot_override` para esa fecha espec√≠fica
4. Sumar los `points_used` de todas las citas existentes en ese slot+fecha
5. Comparar: `puntos_usados + puntos_nueva_cita ‚â§ max_points`
6. Si cabe ‚Üí crear cita. Si no cabe ‚Üí mensaje claro: ¬´La franja 08:00-10:00 est√° llena (5/6 puntos usados, necesitas 2)¬ª

> **Ventaja clave:** El mensaje de conflicto es comprensible por cualquier persona: ¬´No cabe porque la franja de 10 a 12 tiene 5 de 6 puntos ocupados y tu descarga necesita 2¬ª. No hay tasas fraccionarias ni minutos espec√≠ficos.

#### 2.2.6 Visualizaci√≥n en el calendario

El calendario del panel cambia significativamente. En lugar de barras de porcentaje abstractas, cada d√≠a muestra sus franjas con un indicador visual simple:

- Franja verde: menos del 50% de puntos usados
- Franja amarilla: entre 50% y 80% usados
- Franja roja: m√°s del 80% usados
- Franja gris: completa (100%)

Dentro de cada franja se muestran las citas como bloques de tama√±o proporcional a su talla (S peque√±o, M mediano, L grande), facilitando la lectura visual.

En la vista de d√≠a, cada franja muestra:

- ¬´Franja 08:00-10:00: 4/6 puntos ‚Äî Proveedor A (M), Proveedor B (S), Proveedor C (S)¬ª
- Bot√≥n de a√±adir cita directamente dentro de la franja

---

## 3. Optimizaci√≥n del Agente IA

### 3.1 Problema actual

El agente El√≠as Ortega usa Claude Sonnet 4.5 con hasta 10 ciclos de tool-calling por mensaje. Esto es costoso (cada interacci√≥n puede suponer 5-15 llamadas a la API de Anthropic) y lento para un flujo que es esencialmente lineal. El 90% de las conversaciones siguen exactamente el mismo patr√≥n.

### 3.2 Soluci√≥n: Arquitectura h√≠brida

Mantener el agente conversacional (direcci√≥n lo requiere) pero optimizar su uso.

#### 3.2.1 Modelo por fases

| Fase | Acci√≥n | Motor | Coste |
|------|--------|-------|-------|
| **1. Saludo** | Detectar intenci√≥n del proveedor | LLM ligero (Haiku / GPT-4.1-mini) | Bajo |
| **2. Recogida de datos** | Extraer: empresa, mercanc√≠a, unidades, l√≠neas, albaranes | LLM ligero con schema JSON | Bajo |
| **3. C√°lculo** | Determinar talla, puntos, duraci√≥n | Determinista (sin LLM) | Cero |
| **4. B√∫squeda slots** | Encontrar franjas disponibles | Determinista (query BD) | Cero |
| **5. Presentaci√≥n opciones** | Formatear opciones para el proveedor | LLM ligero (template + datos) | Bajo |
| **6. Confirmaci√≥n** | Reservar y confirmar | Determinista + LLM para mensaje final | Bajo |

> **Ahorro estimado:** Pasar de Claude Sonnet 4.5 a Haiku/GPT-4.1-mini para la conversaci√≥n reduce el coste por interacci√≥n entre un 80% y un 95%. Solo las fases 1, 2 y 5 requieren LLM. Las fases 3, 4 y 6 son deterministas y no cuestan nada. Se reserva el modelo potente como fallback para categor√≠as no reconocidas.

#### 3.2.2 Flujo de conversaci√≥n optimizado

El agente sigue siendo conversacional y natural, pero internamente el sistema dirige el flujo:

1. **Proveedor escribe.** LLM ligero analiza el mensaje y extrae datos estructurados (JSON). Si falta informaci√≥n, genera pregunta espec√≠fica. El prompt incluye la lista de campos requeridos y los ya recopilados.
2. **Datos completos.** La calculadora determinista clasifica la mercanc√≠a, calcula talla (S/M/L) y puntos. Si la categor√≠a no se reconoce, se invoca LLM potente como fallback (igual que ahora).
3. **B√∫squeda.** Query directa a BD: buscar slots con puntos suficientes en los pr√≥ximos 5 d√≠as laborables. Sin tool-calling, sin LLM. Retorna hasta 3 opciones.
4. **Presentaci√≥n.** LLM ligero formatea las opciones en lenguaje natural con la personalidad de El√≠as. Template pre-construido con placeholders para los datos.
5. **Confirmaci√≥n.** Proveedor elige. INSERT en BD (sin LLM). LLM ligero genera mensaje de confirmaci√≥n con template.

#### 3.2.3 Cambios t√©cnicos espec√≠ficos

| Componente | Actual | Propuesto |
|------------|--------|-----------|
| Modelo principal | Claude Sonnet 4.5 | Claude Haiku 4.5 o GPT-4.1-mini |
| Modelo fallback | GPT-4.1 (solo calculadora) | Claude Sonnet 4.5 (solo si Haiku no resuelve categor√≠a) |
| Tool-calling | Hasta 10 ciclos por mensaje | M√°ximo 2 ciclos (datos + confirmaci√≥n) |
| Streaming SSE | Todo el mensaje | Se mantiene igual |
| Historial | 20 mensajes (10 intercambios) | Se mantiene igual |
| Prompt sistema | ~2000 tokens con reglas complejas | ~800 tokens, flujo simplificado |
| Horarios almac√©n | Hardcodeados en prompt | Le√≠dos de slot_templates en BD |

#### 3.2.4 Persistencia de sesi√≥n mejorada

Actualmente el chat depende de un sessionId en el navegador que se pierde al cambiar de dispositivo. Se propone:

- **C√≥digo de acceso temporal:** Al iniciar una reserva, el sistema genera un c√≥digo de 6 d√≠gitos que el proveedor puede usar en otro dispositivo para retomar la conversaci√≥n. V√°lido 24 horas.
- **Consulta de citas:** El proveedor puede preguntar a El√≠as ¬´quiero ver mis citas¬ª y, tras verificar con su nombre de empresa, el sistema muestra las citas asociadas a ese proveedor.
- **Enlace directo:** Tras confirmar una reserva, se env√≠a un enlace √∫nico al proveedor (por el propio chat) que le permite consultar o cancelar su cita sin login.

---

## 4. Sistema de Notificaciones por Email

### 4.1 Problema actual

No existe ning√∫n mecanismo de notificaci√≥n. Cuando un proveedor reserva una cita por el chat, el equipo de almac√©n no se entera hasta que abre el panel. En un almac√©n real, esto es cr√≠tico: necesitan saber con antelaci√≥n qu√© llega y cu√°ndo.

### 4.2 Soluci√≥n: Notificaciones exclusivamente por email

El equipo de Centro Hogar Sanchez es tradicional y trabaja con correo electr√≥nico como herramienta principal de comunicaci√≥n. No tiene sentido introducir Telegram, Slack ni notificaciones in-app que nadie va a mirar. El canal √∫nico es el email, con dos tipos de env√≠o:

#### 4.2.1 Resumen diario (producto estrella)

Un email autom√°tico que se env√≠a **todos los d√≠as laborables a las 7:00** con todas las citas programadas para ese d√≠a.

**Contenido del email:**
- Asunto: ¬´üì¶ Citas de almac√©n ‚Äî [Fecha] ‚Äî [N] descargas programadas¬ª
- Tabla con todas las citas del d√≠a: hora, proveedor, tipo de mercanc√≠a, talla (S/M/L), franja asignada
- Resumen de capacidad por franja: ¬´08:00-10:00: 4/6 puntos | 10:00-12:00: 2/6 puntos | 12:00-14:00: libre¬ª
- Notas especiales si hay alg√∫n slot_override activo (festivo parcial, etc.)

**Dise√±o:** HTML sencillo, legible en m√≥vil, imprimible. El jefe de almac√©n debe poder imprimirlo y pegarlo en la pared.

#### 4.2.2 Alertas puntuales

Emails individuales que se env√≠an cuando ocurre un evento relevante:

| Evento | Asunto del email | Destinatarios |
|--------|------------------|---------------|
| Nueva cita creada (desde chat o panel) | ¬´‚úÖ Nueva cita: [Proveedor] ‚Äî [Fecha] [Franja]¬ª | Planificadores |
| Cita modificada | ¬´‚úèÔ∏è Cita modificada: [Proveedor] ‚Äî [Fecha]¬ª | Planificadores |
| Cita cancelada | ¬´‚ùå Cita cancelada: [Proveedor] ‚Äî [Fecha] [Franja]¬ª | Planificadores |
| Cita creada para hoy mismo | ¬´‚ö†Ô∏è URGENTE: Nueva cita HOY ‚Äî [Proveedor] [Franja]¬ª | Jefe almac√©n + planificadores |

#### 4.2.3 Implementaci√≥n t√©cnica

**Servicio de email:** Nodemailer con SMTP (compatible con cualquier proveedor: Gmail, Outlook, servidor propio) o un servicio transaccional como Resend/SendGrid si se prefiere mayor fiabilidad.

**Nueva tabla: `email_recipients`**

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | String (CUID) | Identificador |
| email | String | Direcci√≥n de correo |
| name | String | Nombre del destinatario |
| receives_daily_summary | Boolean | Si recibe el resumen diario |
| receives_alerts | Boolean | Si recibe alertas puntuales |
| receives_urgent | Boolean | Si recibe alertas de citas del mismo d√≠a |
| active | Boolean | Si est√° activo |

**Nueva tabla: `email_log`**

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | String (CUID) | Identificador |
| recipient_email | String | Destinatario |
| type | Enum (DAILY_SUMMARY, ALERT) | Tipo de env√≠o |
| subject | String | Asunto del email |
| status | Enum (SENT, FAILED, RETRYING) | Estado de env√≠o |
| sent_at | DateTime? | Timestamp de env√≠o exitoso |
| error | String? | Detalle de error si fall√≥ |
| created_at | DateTime | Timestamp de creaci√≥n |

**Cron job para resumen diario:** Tarea programada (node-cron o similar) que se ejecuta a las 7:00 Europe/Madrid cada d√≠a laborable, consulta las citas del d√≠a y env√≠a el resumen a todos los destinatarios con `receives_daily_summary = true`.

**Eventos para alertas:** Cada operaci√≥n CRUD sobre citas emite un evento interno. El servicio de email escucha estos eventos y env√≠a las alertas correspondientes de forma as√≠ncrona (para no bloquear la respuesta al usuario).

#### 4.2.4 Configuraci√≥n desde el panel

Se a√±ade un nuevo m√≥dulo ¬´Notificaciones¬ª en el panel de gesti√≥n (solo ADMIN) donde se pueden:

- A√±adir/editar/eliminar destinatarios de email
- Configurar qu√© tipo de emails recibe cada destinatario (resumen diario, alertas, urgentes)
- Ver el log de emails enviados con su estado
- Enviar email de prueba para verificar configuraci√≥n SMTP
- Configurar la hora del resumen diario (por defecto 7:00)

---

## 5. Sistema de Auditor√≠a

### 5.1 Problema actual

No queda registro de qui√©n cre√≥, modific√≥ o elimin√≥ cada cita. Con m√∫ltiples planificadores y el agente IA creando citas, es imposible saber qui√©n hizo qu√© y cu√°ndo.

### 5.2 Soluci√≥n propuesta

**Nueva tabla: `audit_log`**

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| id | String (CUID) | Identificador |
| entity_type | String | Tipo de entidad (appointment, provider, capacity, user) |
| entity_id | String | ID de la entidad afectada |
| action | Enum (CREATE, UPDATE, DELETE) | Acci√≥n realizada |
| actor_type | Enum (USER, CHAT_AGENT, INTEGRATION, SYSTEM) | Qui√©n realiz√≥ la acci√≥n |
| actor_id | String? | ID del usuario o sesi√≥n de chat |
| changes | JSON? | Detalle de campos modificados (before/after) |
| created_at | DateTime | Timestamp |

Cada operaci√≥n de escritura (CREATE, UPDATE, DELETE) en cualquier entidad principal genera autom√°ticamente una entrada en el log de auditor√≠a. Para las modificaciones, se almacena el estado anterior y posterior de los campos cambiados.

#### 5.2.1 Visualizaci√≥n en el panel

- Nuevo m√≥dulo ¬´Historial¬ª accesible para ADMIN y PLANNER
- Filtros por tipo de entidad, acci√≥n, actor y rango de fechas
- En la vista de detalle de cada cita, pesta√±a ¬´Historial¬ª que muestra todas las modificaciones
- Indicador visual: icono de robot para acciones del chat, icono de persona para acciones manuales

---

## 6. Mejoras de Seguridad

### 6.1 API de integraci√≥n cerrada por defecto

Actualmente, si `INTEGRATION_API_KEY` no est√° configurada, los endpoints de integraci√≥n quedan completamente abiertos. La propuesta es invertir este comportamiento:

- Si `INTEGRATION_API_KEY` no est√° configurada: endpoints de integraci√≥n devuelven 403 Forbidden
- Si est√° configurada: funciona como ahora (validaci√≥n de X-API-Key header)
- A√±adir rate limiting espec√≠fico para endpoints de integraci√≥n: 50 requests/minuto

### 6.2 Limpieza del modelo de datos

Eliminar la desnormalizaci√≥n de `provider_name` en la tabla appointments:

- Usar siempre la relaci√≥n `provider_id` como fuente de verdad
- Si un proveedor llega por el chat y no existe, crearlo autom√°ticamente en la tabla providers
- Migrar citas existentes: para aquellas sin `provider_id`, buscar/crear el proveedor por nombre y establecer la relaci√≥n
- Mantener `provider_name` como campo calculado (JOIN) en las consultas, no como dato almacenado

### 6.3 Mejora de tokens JWT

- Reducir expiraci√≥n de 7 d√≠as a 24 horas
- Implementar refresh token (expiraci√≥n 7 d√≠as) para renovaci√≥n autom√°tica
- Almacenar refresh token en httpOnly cookie en lugar de localStorage
- A√±adir endpoint `POST /api/auth/refresh` para renovar access token

---

## 7. Mejoras de Arquitectura

### 7.1 Separaci√≥n del worker de IA

El problema principal es que las llamadas a LLMs pueden tardar 5-30 segundos y bloquean capacidad del servidor Express. En escenarios de carga (varios proveedores usando el chat simult√°neamente), esto puede degradar el rendimiento del panel de gesti√≥n.

La soluci√≥n propuesta es desacoplar el procesamiento de IA:

- **Opci√≥n A (m√≠nima):** Worker thread de Node.js. El servidor principal delega el procesamiento de chat a un worker thread que tiene su propio event loop. No requiere infraestructura adicional.
- **Opci√≥n B (recomendada si crece):** BullMQ con Redis. Cola de mensajes que permite escalar el n√∫mero de workers independientemente. Cada worker procesa un mensaje del chat a la vez.

> **Recomendaci√≥n:** Para el contexto actual (Replit, pocos usuarios concurrentes), la Opci√≥n A (worker thread) es suficiente y no a√±ade complejidad. Si en el futuro el uso del chat crece significativamente, migrar a BullMQ es sencillo porque la interfaz es similar.

### 7.2 Horarios din√°micos para el agente

Actualmente los horarios del almac√©n est√°n hardcodeados en el prompt del LLM. Cuando el almac√©n cambie horarios, habr√° que modificar c√≥digo.

Con el nuevo modelo de slots, el agente puede leer din√°micamente:

- Los `slot_templates` para saber los horarios base del almac√©n
- Los `slot_overrides` para saber si hay d√≠as cerrados o con horario especial
- Esta informaci√≥n se inyecta en el prompt del sistema en cada conversaci√≥n, no se hardcodea

---

## 8. Plan de Fases de Implementaci√≥n

> **Enfoque incremental:** Cada fase es desplegable de forma independiente. La fase 1 es la m√°s cr√≠tica porque cambia el modelo de capacidad, que afecta a todo el sistema. Las fases posteriores son mejoras incrementales que no rompen funcionalidad existente.

### Fase 1: Nuevo modelo de capacidad + Notificaciones por email

**Duraci√≥n estimada:** 2-3 semanas  
**Prioridad:** üî¥ CR√çTICA

**Tareas de backend:**

1. Crear tablas `slot_templates`, `slot_overrides` y migraci√≥n de datos
2. Implementar nuevo validador de capacidad basado en puntos
3. A√±adir campos `size`, `points_used`, `slot_date`, `slot_start_time` a appointments
4. Migrar citas existentes al nuevo modelo (asignar tallas retroactivamente)
5. Actualizar endpoints REST para usar el nuevo modelo
6. Implementar servicio de email con Nodemailer (resumen diario + alertas)
7. Crear tablas `email_recipients` y `email_log`
8. Implementar cron job para resumen diario a las 7:00

**Tareas de frontend:**

1. Redise√±ar p√°gina de Capacidad para gestionar slots en vez de turnos
2. Redise√±ar calendario para mostrar franjas con puntos
3. Actualizar formulario de citas (selector de franja, indicador de talla)
4. Nuevo m√≥dulo de Notificaciones (solo ADMIN): destinatarios, log, prueba de env√≠o
5. Actualizar mensajes de error de conflicto de capacidad

### Fase 2: Optimizaci√≥n del agente IA

**Duraci√≥n estimada:** 1-2 semanas  
**Prioridad:** üü° ALTA

1. Cambiar modelo principal del orquestador a Haiku/GPT-4.1-mini
2. Reestructurar el flujo del agente a fases deterministas
3. Actualizar prompt del sistema para leer horarios de `slot_templates`
4. Reducir tool-calling a m√°ximo 2 ciclos por mensaje
5. Simplificar prompts (~800 tokens vs ~2000 actuales)
6. Implementar c√≥digo de acceso temporal para sesiones de chat
7. A√±adir consulta de citas por nombre de proveedor en el chat

### Fase 3: Auditor√≠a y seguridad

**Duraci√≥n estimada:** 1 semana  
**Prioridad:** ‚ö™ MEDIA

1. Crear tabla `audit_log`
2. Implementar middleware de auditor√≠a autom√°tica en operaciones CRUD
3. Crear m√≥dulo Historial en el panel
4. Invertir comportamiento de `INTEGRATION_API_KEY` (cerrado por defecto)
5. Eliminar desnormalizaci√≥n de `provider_name` + migraci√≥n
6. Implementar refresh tokens + httpOnly cookies

### Fase 4: Arquitectura y optimizaci√≥n

**Duraci√≥n estimada:** 1 semana  
**Prioridad:** ‚ö™ BAJA (ejecutar solo si hay carga real)

1. Implementar worker thread para procesamiento de IA
2. Implementar resumen diario configurable (hora de env√≠o ajustable)
3. Optimizar cach√© de `slot_templates` (evitar queries repetidas)
4. Tests e2e para el flujo completo del chat

---

## 9. Resumen de Cambios en Base de Datos

### 9.1 Tablas nuevas

| Tabla | Fase | Descripci√≥n |
|-------|------|-------------|
| **slot_templates** | Fase 1 | Plantillas de franjas horarias semanales |
| **slot_overrides** | Fase 1 | Excepciones a las franjas (festivos, eventos) |
| **email_recipients** | Fase 1 | Destinatarios de notificaciones por email |
| **email_log** | Fase 1 | Registro de emails enviados |
| **audit_log** | Fase 3 | Log de auditor√≠a de todas las operaciones |

### 9.2 Tablas modificadas

| Tabla | Cambio | Fase |
|-------|--------|------|
| **appointments** | A√±adir: `size` (Enum S/M/L), `points_used` (Int), `slot_date` (Date), `slot_start_time` (String) | Fase 1 |
| **appointments** | Eliminar: `provider_name` (usar JOIN). Hacer `provider_id` NOT NULL | Fase 3 |
| **users** | A√±adir: `refresh_token` (String?), `refresh_token_expires` (DateTime?) | Fase 3 |

### 9.3 Tablas eliminadas

| Tabla | Motivo | Fase |
|-------|--------|------|
| **capacity_shifts** | Reemplazada por `slot_templates` + `slot_overrides` | Fase 1 |

---

## 10. M√©tricas de √âxito

Para evaluar si las mejoras cumplen sus objetivos, se proponen las siguientes m√©tricas:

| M√©trica | Actual (estimado) | Objetivo | C√≥mo medir |
|---------|-------------------|----------|------------|
| Tiempo medio de reserva por chat | 3-5 minutos | <2 minutos | Timestamp primer mensaje vs confirmaci√≥n |
| Coste por reserva (tokens LLM) | ~$0.05-0.15 | <$0.02 | Tokens consumidos por sesi√≥n de chat |
| % de conflictos resueltos sin ayuda | ~30% (dato opaco) | >80% (mensaje claro) | Encuesta al equipo tras 1 mes |
| Tiempo de respuesta del chat (primer token) | 2-5 segundos | <1 segundo | Latencia SSE medida en logs |
| Citas creadas por chat sin intervenci√≥n manual | Sin dato | >90% | Ratio chat completados vs abandonados |
| Emails entregados correctamente | N/A | >99% | `email_log` con status=SENT |
| Equipo revisa resumen diario | N/A | >90% d√≠as | Encuesta al equipo tras 1 mes |

---

> **Siguiente paso:** Revisar este plan con el equipo t√©cnico y el jefe de almac√©n. Validar especialmente: (1) que las franjas horarias propuestas tienen sentido operativo, (2) que el sistema de tallas S/M/L cubre todos los casos reales, y (3) que los destinatarios de email y la hora del resumen diario son los correctos. Una vez validado, iniciar la Fase 1.