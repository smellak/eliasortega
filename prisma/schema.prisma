generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  passwordHash        String    @map("password_hash")
  role                UserRole  @default(BASIC_READONLY)
  refreshToken        String?   @map("refresh_token")
  refreshTokenExpires DateTime? @map("refresh_token_expires")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@map("users")
}

enum UserRole {
  ADMIN
  PLANNER
  BASIC_READONLY
}

model Provider {
  id           String        @id @default(cuid())
  name         String        @unique
  notes        String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  appointments Appointment[]

  @@map("providers")
}

model CapacityShift {
  id        String   @id @default(cuid())
  startUtc  DateTime @map("start_utc")
  endUtc    DateTime @map("end_utc")
  workers   Int      @default(0)
  forklifts Int      @default(0)
  docks     Int?     @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([startUtc, endUtc])
  @@map("capacity_shifts")
}

model SlotTemplate {
  id        String   @id @default(cuid())
  /// 0 = Sunday, 1 = Monday, ..., 6 = Saturday (JavaScript Date.getDay() convention)
  dayOfWeek Int      @map("day_of_week")
  startTime String   @map("start_time")
  endTime   String   @map("end_time")
  maxPoints Int      @default(6) @map("max_points")
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  dockAvailabilities DockSlotAvailability[]

  @@index([dayOfWeek])
  @@map("slot_templates")
}

model Dock {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  sortOrder Int      @default(0) @map("sort_order")
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  availabilities DockSlotAvailability[]
  overrides      DockOverride[]
  appointments   Appointment[]

  @@map("docks")
}

model DockSlotAvailability {
  id             String   @id @default(cuid())
  dockId         String   @map("dock_id")
  slotTemplateId String   @map("slot_template_id")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  dock         Dock         @relation(fields: [dockId], references: [id], onDelete: Cascade)
  slotTemplate SlotTemplate @relation(fields: [slotTemplateId], references: [id], onDelete: Cascade)

  @@unique([dockId, slotTemplateId])
  @@map("dock_slot_availability")
}

model DockOverride {
  id        String    @id @default(cuid())
  dockId    String    @map("dock_id")
  date      DateTime
  dateEnd   DateTime? @map("date_end")
  isActive  Boolean   @default(false) @map("is_active")
  reason    String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  dock Dock @relation(fields: [dockId], references: [id], onDelete: Cascade)

  @@index([dockId, date])
  @@index([dateEnd])
  @@map("dock_overrides")
}

model SlotOverride {
  id        String    @id @default(cuid())
  date      DateTime
  dateEnd   DateTime? @map("date_end")
  startTime String?   @map("start_time")
  endTime   String?   @map("end_time")
  maxPoints Int       @default(0) @map("max_points")
  reason    String?
  source    String    @default("manual")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@index([date])
  @@index([dateEnd])
  @@map("slot_overrides")
}

enum AppointmentSize {
  S
  M
  L
}

model Appointment {
  id                 String           @id @default(cuid())
  providerId         String?          @map("provider_id")
  provider           Provider?        @relation(fields: [providerId], references: [id], onDelete: SetNull)
  providerName       String           @map("provider_name")
  startUtc           DateTime         @map("start_utc")
  endUtc             DateTime         @map("end_utc")
  workMinutesNeeded  Int              @map("work_minutes_needed")
  forkliftsNeeded    Int              @map("forklifts_needed")
  goodsType          String?          @map("goods_type")
  units              Int?
  lines              Int?
  deliveryNotesCount Int?             @map("delivery_notes_count")
  externalRef        String?          @unique @map("external_ref")
  size               AppointmentSize?
  pointsUsed         Int?             @map("points_used")
  slotDate           DateTime?        @map("slot_date")
  slotStartTime      String?          @map("slot_start_time")
  estimatedFields    String?          @map("estimated_fields")
  dockId             String?          @map("dock_id")
  dock               Dock?            @relation(fields: [dockId], references: [id], onDelete: SetNull)
  providerEmail      String?          @map("provider_email")
  providerPhone      String?          @map("provider_phone")
  confirmationStatus String           @default("pending") @map("confirmation_status")
  confirmationToken  String?          @unique @map("confirmation_token")
  confirmationSentAt DateTime?        @map("confirmation_sent_at")
  reminderSentAt     DateTime?        @map("reminder_sent_at")
  confirmedAt        DateTime?        @map("confirmed_at")
  cancelledAt        DateTime?        @map("cancelled_at")
  cancellationReason String?          @map("cancellation_reason")
  actualStartUtc     DateTime?        @map("actual_start_utc")
  actualEndUtc       DateTime?        @map("actual_end_utc")
  actualUnits        Int?             @map("actual_units")
  checkedInBy        String?          @map("checked_in_by")
  checkedOutBy       String?          @map("checked_out_by")
  actualDurationMin  Float?           @map("actual_duration_min")
  predictionErrorMin Float?           @map("prediction_error_min")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  @@index([startUtc])
  @@index([endUtc])
  @@index([providerName])
  @@index([slotDate, slotStartTime])
  @@index([confirmationStatus])
  @@index([dockId, slotDate, startUtc, endUtc])
  @@index([actualStartUtc])
  @@map("appointments")
}

model AppConfig {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("app_config")
}

model CalibrationSnapshot {
  id         String    @id @default(uuid())
  createdAt  DateTime  @default(now()) @map("created_at")
  category   String
  sampleSize Int       @map("sample_size")
  newTD      Float     @map("new_td")
  newTA      Float     @map("new_ta")
  newTL      Float     @map("new_tl")
  newTU      Float     @map("new_tu")
  oldTD      Float     @map("old_td")
  oldTA      Float     @map("old_ta")
  oldTL      Float     @map("old_tl")
  oldTU      Float     @map("old_tu")
  maeOld     Float     @map("mae_old")
  maeNew     Float     @map("mae_new")
  appliedAt  DateTime? @map("applied_at")
  appliedBy  String?   @map("applied_by")
  status     String    @default("pending")

  @@index([category])
  @@index([status])
  @@map("calibration_snapshots")
}

model EmailRecipient {
  id                   String   @id @default(cuid())
  email                String   @unique
  name                 String
  receivesDailySummary Boolean  @default(true) @map("receives_daily_summary")
  receivesAlerts       Boolean  @default(true) @map("receives_alerts")
  receivesUrgent       Boolean  @default(true) @map("receives_urgent")
  active               Boolean  @default(true)
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("email_recipients")
}

enum EmailType {
  DAILY_SUMMARY
  ALERT
}

enum EmailStatus {
  SENT
  FAILED
  RETRYING
}

model EmailLog {
  id             String      @id @default(cuid())
  recipientEmail String      @map("recipient_email")
  type           EmailType
  subject        String
  status         EmailStatus @default(SENT)
  sentAt         DateTime?   @map("sent_at")
  error          String?
  createdAt      DateTime    @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([recipientEmail])
  @@map("email_log")
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

enum ActorType {
  USER
  CHAT_AGENT
  INTEGRATION
  SYSTEM
}

model AuditLog {
  id         String      @id @default(cuid())
  entityType String      @map("entity_type")
  entityId   String      @map("entity_id")
  action     AuditAction
  actorType  ActorType   @map("actor_type")
  actorId    String?     @map("actor_id")
  changes    Json?
  createdAt  DateTime    @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([actorType])
  @@map("audit_log")
}

model Conversation {
  id        String    @id @default(cuid())
  sessionId String    @unique @map("session_id")
  metadata  Json?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  messages  Message[]

  @@index([sessionId])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String       @map("conversation_id")
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           MessageRole
  content        String
  metadata       Json?
  createdAt      DateTime     @default(now()) @map("created_at")

  @@index([conversationId])
  @@index([createdAt])
  @@map("messages")
}

enum MessageRole {
  user
  assistant
  system
  tool
}
